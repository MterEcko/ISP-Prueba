<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paquetes - ISP-Prueba Store</title>
  <link rel="stylesheet" href="/dashboard/static/css/dashboard.css">
  <style>
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5)}.modal.active{display:flex;align-items:center;justify-content:center}.modal-content{background-color:white;padding:30px;border-radius:8px;max-width:800px;width:90%;max-height:90vh;overflow-y:auto}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}.modal-header h3{margin:0;color:#2c3e50}.close-btn{background:none;border:none;font-size:28px;cursor:pointer;color:#999;padding:0;width:30px;height:30px;line-height:1}.close-btn:hover{color:#333}.form-group{margin-bottom:20px}.form-group label{display:block;margin-bottom:8px;font-weight:600;color:#34495e}.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 15px;border:1px solid #ddd;border-radius:4px;font-size:14px;font-family:inherit}.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#3498db}.form-group small{display:block;margin-top:5px;color:#7f8c8d;font-size:12px}.form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px}.form-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:25px;padding-top:20px;border-top:1px solid #f0f0f0}.btn{padding:10px 20px;border:none;border-radius:4px;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.2s}.btn-primary{background-color:#3498db;color:white}.btn-primary:hover{background-color:#2980b9}.btn-secondary{background-color:#95a5a6;color:white}.btn-secondary:hover{background-color:#7f8c8d}.btn-success{background-color:#27ae60;color:white}.btn-success:hover{background-color:#229954}.btn-danger{background-color:#e74c3c;color:white}.btn-danger:hover{background-color:#c0392b}.action-buttons{display:flex;gap:5px}.action-btn{padding:5px 10px;border:none;border-radius:3px;cursor:pointer;font-size:12px;transition:all 0.2s}.action-btn:hover{opacity:0.8}.alert{padding:15px;border-radius:4px;margin-bottom:20px}.alert-success{background-color:#d4edda;color:#155724;border:1px solid #c3e6cb}.alert-error{background-color:#f8d7da;color:#721c24;border:1px solid #f5c6cb}.plugin-list{display:grid;gap:10px}.plugin-item{border:1px solid #ddd;padding:15px;border-radius:4px;display:flex;justify-content:space-between;align-items:center}.plugin-item-info h4{margin:0 0 5px 0;color:#2c3e50}.plugin-item-info p{margin:0;color:#7f8c8d;font-size:12px}.checkbox-group{display:flex;gap:20px;margin:10px 0}.checkbox-group label{display:flex;align-items:center;gap:5px;cursor:pointer;font-weight:normal}
  </style>
</head>
<body>
  <div class="dashboard-container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>ISP-Prueba Store</h1>
        <p>Panel de Administraci√≥n</p>
      </div>
      <ul class="sidebar-menu">
        <li><a href="/dashboard"><span class="icon">üìä</span> Dashboard</a></li>
        <li><a href="/dashboard/installations"><span class="icon">üíª</span> Instalaciones</a></li>
        <li><a href="/dashboard/licenses"><span class="icon">üîë</span> Licencias</a></li>
        <li><a href="/dashboard/plugins"><span class="icon">üß©</span> Plugins</a></li>
        <li><a href="/dashboard/packages" class="active"><span class="icon">üì¶</span> Paquetes</a></li>
        <li><a href="/dashboard/customers"><span class="icon">üë•</span> Clientes</a></li>
        <li><a href="/dashboard/map"><span class="icon">üó∫Ô∏è</span> Mapa</a></li>
      </ul>
    </aside>

    <main class="main-content">
      <div class="page-header">
        <div>
          <h2>Gesti√≥n de Paquetes</h2>
          <p>Crea y configura paquetes de servicio con sus plugins</p>
        </div>
        <button class="btn btn-primary" onclick="openCreateModal()">‚ûï Crear Paquete</button>
      </div>

      <div class="stats-grid" id="statsGrid">
        <div class="loading"><div class="spinner"></div><p>Cargando...</p></div>
      </div>

      <div class="data-table">
        <div class="table-header">
          <h3>Lista de Paquetes</h3>
        </div>
        <div id="packagesTable">
          <div class="loading"><div class="spinner"></div><p>Cargando paquetes...</p></div>
        </div>
      </div>
    </main>
  </div>

  <!-- Create/Edit Package Modal -->
  <div id="packageModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Crear Paquete</h3>
        <button class="close-btn" onclick="closePackageModal()">&times;</button>
      </div>
      <div id="modalAlert"></div>
      <form id="packageForm" onsubmit="savePackage(event)">
        <input type="hidden" id="packageId">
        <div class="form-row">
          <div class="form-group">
            <label>Nombre del Paquete *</label>
            <input type="text" id="name" required>
          </div>
          <div class="form-group">
            <label>Precio *</label>
            <input type="number" id="price" step="0.01" required>
          </div>
        </div>
        <div class="form-group">
          <label>Descripci√≥n</label>
          <textarea id="description" rows="3"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>L√≠mite de Clientes</label>
            <input type="number" id="clientLimit" placeholder="Dejar vac√≠o = ilimitado">
          </div>
          <div class="form-group">
            <label>L√≠mite de Usuarios</label>
            <input type="number" id="userLimit" placeholder="Dejar vac√≠o = ilimitado">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Ciclo de Facturaci√≥n</label>
            <select id="billingCycle">
              <option value="monthly">Mensual</option>
              <option value="yearly">Anual</option>
              <option value="one-time">√önico</option>
            </select>
          </div>
          <div class="form-group">
            <label>Estado</label>
            <select id="status">
              <option value="active">Activo</option>
              <option value="inactive">Inactivo</option>
            </select>
          </div>
        </div>
        <div class="checkbox-group">
          <label><input type="checkbox" id="isFree"> Es Gratis</label>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closePackageModal()">Cancelar</button>
          <button type="submit" class="btn btn-success">Guardar Paquete</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Manage Plugins Modal -->
  <div id="pluginsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Gestionar Plugins - <span id="packageName"></span></h3>
        <button class="close-btn" onclick="closePluginsModal()">&times;</button>
      </div>
      <div id="pluginsAlert"></div>
      <div id="pluginsList"></div>
    </div>
  </div>

  <script>
    const API_URL = window.location.origin + '/api';
    let packages = [], allPlugins = [], currentPackage = null;

    async function init() {
      await Promise.all([loadPackages(), loadAllPlugins(), loadStats()]);
    }

    async function loadAllPlugins() {
      try {
        const res = await fetch(`${API_URL}/plugins`);
        const data = await res.json();
        if (data.success) allPlugins = data.data;
      } catch (e) { console.error('Error loading plugins:', e); }
    }

    async function loadPackages() {
      try {
        const res = await fetch(`${API_URL}/service-packages?includePlugins=true`);
        const data = await res.json();
        if (data.success) { packages = data.data; renderPackagesTable(packages); }
      } catch (e) {
        console.error('Error:', e);
        document.getElementById('packagesTable').innerHTML = '<div class="loading"><p style="color:#e74c3c;">‚ùå Error al cargar</p></div>';
      }
    }

    async function loadStats() {
      const stats = { total: packages.length, active: packages.filter(p => p.status === 'active').length, free: packages.filter(p => p.isFree).length };
      document.getElementById('statsGrid').innerHTML = `
        <div class="stat-card"><div class="stat-card-header"><span class="stat-card-title">Total Paquetes</span><div class="stat-card-icon" style="background:#e3f2fd;color:#2196f3;">üì¶</div></div><div class="stat-card-value">${stats.total}</div></div>
        <div class="stat-card"><div class="stat-card-header"><span class="stat-card-title">Activos</span><div class="stat-card-icon" style="background:#e8f5e9;color:#4caf50;">‚úÖ</div></div><div class="stat-card-value">${stats.active}</div></div>
        <div class="stat-card"><div class="stat-card-header"><span class="stat-card-title">Gratis</span><div class="stat-card-icon" style="background:#fff3e0;color:#ff9800;">üéÅ</div></div><div class="stat-card-value">${stats.free}</div></div>
      `;
    }

    function renderPackagesTable(pkgs) {
      if (!pkgs || pkgs.length === 0) {
        document.getElementById('packagesTable').innerHTML = '<p style="padding:20px;text-align:center;color:#999;">No hay paquetes</p>';
        return;
      }
      document.getElementById('packagesTable').innerHTML = `<table><thead><tr><th>Paquete</th><th>Precio</th><th>L√≠mites</th><th>Plugins</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>${pkgs.map(pkg => `<tr><td><strong>${pkg.name}</strong><br><small style="color:#7f8c8d;">${pkg.description || ''}</small></td><td>$${pkg.price} ${pkg.currency}${pkg.isFree ? '<br><span class="badge badge-success">Gratis</span>' : ''}</td><td><small>Clientes: ${pkg.clientLimit || '‚àû'}<br>Usuarios: ${pkg.userLimit || '‚àû'}</small></td><td><span class="badge">${pkg.plugins ? pkg.plugins.length : 0} plugins</span></td><td><span class="badge badge-${pkg.status === 'active' ? 'success' : 'info'}">${pkg.status === 'active' ? 'Activo' : 'Inactivo'}</span></td><td><div class="action-buttons"><button class="action-btn btn-primary" onclick="openPluginsModal('${pkg.id}')">üß© Plugins</button><button class="action-btn btn-secondary" onclick="editPackage('${pkg.id}')">‚úèÔ∏è Editar</button></div></td></tr>`).join('')}</tbody></table>`;
    }

    function openCreateModal() {
      document.getElementById('modalTitle').textContent = 'Crear Paquete';
      document.getElementById('packageForm').reset();
      document.getElementById('packageId').value = '';
      document.getElementById('packageModal').classList.add('active');
    }

    function closePackageModal() { document.getElementById('packageModal').classList.remove('active'); }

    async function savePackage(e) {
      e.preventDefault();
      const id = document.getElementById('packageId').value;
      const data = {
        name: document.getElementById('name').value,
        description: document.getElementById('description').value,
        price: parseFloat(document.getElementById('price').value),
        clientLimit: document.getElementById('clientLimit').value || null,
        userLimit: document.getElementById('userLimit').value || null,
        billingCycle: document.getElementById('billingCycle').value,
        status: document.getElementById('status').value,
        isFree: document.getElementById('isFree').checked
      };

      try {
        const method = id ? 'PUT' : 'POST';
        const url = id ? `${API_URL}/service-packages/${id}` : `${API_URL}/service-packages`;
        const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        const result = await res.json();

        if (result.success) {
          alert('‚úÖ Paquete guardado exitosamente');
          closePackageModal();
          loadPackages();
          loadStats();
        } else { alert(`‚ùå Error: ${result.message}`); }
      } catch (e) { alert(`‚ùå Error: ${e.message}`); }
    }

    async function editPackage(id) {
      const pkg = packages.find(p => p.id === id);
      if (!pkg) return;
      document.getElementById('modalTitle').textContent = 'Editar Paquete';
      document.getElementById('packageId').value = pkg.id;
      document.getElementById('name').value = pkg.name;
      document.getElementById('description').value = pkg.description || '';
      document.getElementById('price').value = pkg.price;
      document.getElementById('clientLimit').value = pkg.clientLimit || '';
      document.getElementById('userLimit').value = pkg.userLimit || '';
      document.getElementById('billingCycle').value = pkg.billingCycle;
      document.getElementById('status').value = pkg.status;
      document.getElementById('isFree').checked = pkg.isFree;
      document.getElementById('packageModal').classList.add('active');
    }

    async function openPluginsModal(packageId) {
      currentPackage = packages.find(p => p.id === packageId);
      if (!currentPackage) return;
      document.getElementById('packageName').textContent = currentPackage.name;
      document.getElementById('pluginsModal').classList.add('active');
      await loadPackagePlugins();
    }

    function closePluginsModal() { document.getElementById('pluginsModal').classList.remove('active'); }

    async function loadPackagePlugins() {
      const packagePlugins = currentPackage.plugins || [];
      const html = `<div class="plugin-list">${allPlugins.map(plugin => {
        const existing = packagePlugins.find(p => p.id === plugin.id);
        const config = existing ? existing.PluginPackage : null;
        const isAssigned = !!existing;
        return `<div class="plugin-item"><div class="plugin-item-info"><h4>${plugin.name}</h4><p>${plugin.description || ''}</p>${isAssigned ? `<div class="checkbox-group"><label><input type="checkbox" ${config?.isFree ? 'checked' : ''} onchange="updatePluginConfig('${plugin.id}', 'isFree', this.checked)"> Gratis</label><label><input type="checkbox" ${config?.isEnabled ? 'checked' : ''} onchange="updatePluginConfig('${plugin.id}', 'isEnabled', this.checked)"> Habilitado</label></div>` : ''}</div><div>${isAssigned ? `<button class="action-btn btn-danger" onclick="removePlugin('${plugin.id}')">‚ùå Remover</button>` : `<button class="action-btn btn-success" onclick="addPlugin('${plugin.id}')">‚ûï Agregar</button>`}</div></div>`;
      }).join('')}</div>`;
      document.getElementById('pluginsList').innerHTML = html;
    }

    async function addPlugin(pluginId) {
      try {
        const res = await fetch(`${API_URL}/service-packages/${currentPackage.id}/plugins`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ pluginId, isFree: true, isEnabled: true }) });
        const result = await res.json();
        if (result.success) { await loadPackages(); await openPluginsModal(currentPackage.id); }
        else { alert(`‚ùå Error: ${result.message}`); }
      } catch (e) { alert(`‚ùå Error: ${e.message}`); }
    }

    async function removePlugin(pluginId) {
      if (!confirm('¬øRemover este plugin del paquete?')) return;
      try {
        const res = await fetch(`${API_URL}/service-packages/${currentPackage.id}/plugins/${pluginId}`, { method: 'DELETE' });
        const result = await res.json();
        if (result.success) { await loadPackages(); await openPluginsModal(currentPackage.id); }
        else { alert(`‚ùå Error: ${result.message}`); }
      } catch (e) { alert(`‚ùå Error: ${e.message}`); }
    }

    async function updatePluginConfig(pluginId, field, value) {
      try {
        const res = await fetch(`${API_URL}/service-packages/${currentPackage.id}/plugins/${pluginId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ [field]: value }) });
        const result = await res.json();
        if (result.success) { await loadPackages(); }
        else { alert(`‚ùå Error: ${result.message}`); }
      } catch (e) { alert(`‚ùå Error: ${e.message}`); }
    }

    init();
    setInterval(() => { loadPackages(); loadStats(); }, 30000);
  </script>
</body>
</html>
