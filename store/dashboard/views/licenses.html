<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Licencias - ISP-Prueba Store</title>
  <link rel="stylesheet" href="/dashboard/static/css/dashboard.css">
</head>
<body>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>ISP-Prueba Store</h1>
        <p>Panel de AdministraciÃ³n</p>
      </div>
      <ul class="sidebar-menu">
        <li><a href="/dashboard">
          <span class="icon">ğŸ“Š</span> Dashboard
        </a></li>
        <li><a href="/dashboard/installations">
          <span class="icon">ğŸ’»</span> Instalaciones
        </a></li>
        <li><a href="/dashboard/licenses" class="active">
          <span class="icon">ğŸ”‘</span> Licencias
        </a></li>
        <li><a href="/dashboard/plugins">
          <span class="icon">ğŸ§©</span> Plugins
        </a></li>
        <li><a href="/dashboard/packages">
          <span class="icon">ğŸ“¦</span> Paquetes
        </a></li>
        <li><a href="/dashboard/customers">
          <span class="icon">ğŸ‘¥</span> Clientes
        </a></li>
        <li><a href="/dashboard/map">
          <span class="icon">ğŸ—ºï¸</span> Mapa
        </a></li>
      </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <h2>Licencias</h2>
        <p>Gestiona las licencias del sistema</p>
      </div>

      <!-- Actions -->
      <div style="margin-bottom: 20px;">
        <button class="btn btn-primary" onclick="showCreateLicenseDialog()">â• Generar Nueva Licencia</button>
      </div>

      <!-- Data Table -->
      <div class="data-table">
        <div class="table-header">
          <h3>Todas las Licencias</h3>
          <div class="search-box">
            <span>ğŸ”</span>
            <input type="text" id="searchInput" placeholder="Buscar por clave de licencia...">
          </div>
        </div>
        <div id="licensesTable">
          <div class="loading">
            <div class="spinner"></div>
            <p>Cargando licencias...</p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Create License Dialog (Simple Modal) -->
  <div id="createLicenseDialog" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
      <h3 style="margin-bottom: 20px;">Generar Nueva Licencia</h3>

      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Paquete de Servicio</label>
        <select id="packageSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
          <option value="">Cargando paquetes...</option>
        </select>
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">DuraciÃ³n (dÃ­as)</label>
        <input type="number" id="durationDays" value="365" min="1" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">
          <input type="checkbox" id="neverExpires"> Nunca expira
        </label>
      </div>

      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn" onclick="hideCreateLicenseDialog()" style="background: #999;">Cancelar</button>
        <button class="btn btn-primary" onclick="createLicense()">Generar Licencia</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = window.location.origin + '/api';
    let allLicenses = [];
    let allPackages = [];

    async function loadPackages() {
      try {
        const response = await fetch(`${API_URL}/service-packages`);
        const data = await response.json();

        if (data.success && data.data) {
          allPackages = data.data;
          const select = document.getElementById('packageSelect');
          select.innerHTML = allPackages.map(pkg => `
            <option value="${pkg.id}" data-slug="${pkg.slug}">
              ${pkg.name} - ${pkg.clientLimit ? pkg.clientLimit + ' clientes' : 'Ilimitado'} - $${pkg.price}/${pkg.billingCycle === 'monthly' ? 'mes' : 'aÃ±o'}
            </option>
          `).join('');
        }
      } catch (error) {
        console.error('Error loading packages:', error);
        document.getElementById('packageSelect').innerHTML = '<option value="">Error al cargar paquetes</option>';
      }
    }

    async function loadLicenses() {
      try {
        const response = await fetch(`${API_URL}/licenses`);
        const data = await response.json();

        if (data.success) {
          allLicenses = data.data;
          renderLicenses(allLicenses);
        }
      } catch (error) {
        console.error('Error loading licenses:', error);
        document.getElementById('licensesTable').innerHTML = `
          <div class="loading">
            <p style="color: #e74c3c;">âŒ Error al cargar las licencias</p>
          </div>
        `;
      }
    }

    function renderLicenses(licenses) {
      const tableDiv = document.getElementById('licensesTable');

      if (!licenses || licenses.length === 0) {
        tableDiv.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">No hay licencias registradas</p>';
        return;
      }

      tableDiv.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Clave de Licencia</th>
              <th>Paquete</th>
              <th>Estado</th>
              <th>LÃ­mite de Clientes</th>
              <th>Asignada a</th>
              <th>Expira</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            ${licenses.map(lic => `
              <tr>
                <td>
                  <code style="font-size: 12px;">${lic.licenseKey}</code>
                  ${lic.isMasterLicense ? '<br><span class="badge badge-danger">â­ MASTER</span>' : ''}
                </td>
                <td>
                  ${lic.servicePackage ?
                    `<span class="badge badge-info">${lic.servicePackage.name}</span>` :
                    `<span class="badge" style="background:#999;color:white">${getPlanText(lic.planType)}</span>`
                  }
                </td>
                <td><span class="badge badge-${getStatusBadgeClass(lic.status)}">${getStatusText(lic.status)}</span></td>
                <td>${lic.clientLimit ? `<strong>${lic.clientLimit}</strong> clientes` : 'â™¾ï¸ Ilimitado'}</td>
                <td>
                  ${lic.installation ? `
                    <strong>${lic.installation.companyName}</strong><br>
                    <small>${lic.boundToHardwareId ? lic.boundToHardwareId.substring(0, 16) + '...' : ''}</small>
                  ` : '<span style="color: #999;">No asignada</span>'}
                </td>
                <td>
                  ${lic.expiresAt ? `
                    ${new Date(lic.expiresAt) > new Date() ?
                      `${formatDate(lic.expiresAt)}` :
                      '<span style="color: #e74c3c;">âš ï¸ Expirada</span>'
                    }
                  ` : 'â™¾ï¸ Nunca'}
                </td>
                <td>
                  <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                    ${!lic.isMasterLicense && lic.status !== 'suspended' && lic.status !== 'revoked' ?
                      `<button class="btn btn-sm" style="background:#f39c12;color:white;padding:4px 8px;font-size:11px;" onclick="suspendLicense('${lic.licenseKey}')">ğŸš« Suspender</button>` :
                      ''
                    }
                    ${lic.status === 'suspended' ?
                      `<button class="btn btn-sm" style="background:#27ae60;color:white;padding:4px 8px;font-size:11px;" onclick="reactivateLicense('${lic.licenseKey}')">âœ… Reactivar</button>` :
                      ''
                    }
                    ${lic.installation && (lic.status === 'active' || lic.status === 'suspended') ?
                      `<button class="btn btn-sm" style="background:#3498db;color:white;padding:4px 8px;font-size:11px;" onclick="triggerHeartbeat('${lic.licenseKey}')">ğŸ’“ Heartbeat</button>` :
                      ''
                    }
                    ${lic.status === 'active' && !lic.isMasterLicense ?
                      `<button class="btn btn-danger btn-sm" style="padding:4px 8px;font-size:11px;" onclick="revokeLicense('${lic.licenseKey}')">âŒ Revocar</button>` :
                      ''
                    }
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function showCreateLicenseDialog() {
      document.getElementById('createLicenseDialog').style.display = 'flex';
      // Cargar paquetes si aÃºn no se han cargado
      if (allPackages.length === 0) {
        await loadPackages();
      }
    }

    function hideCreateLicenseDialog() {
      document.getElementById('createLicenseDialog').style.display = 'none';
    }

    async function createLicense() {
      const packageSelect = document.getElementById('packageSelect');
      const servicePackageId = packageSelect.value;
      const selectedOption = packageSelect.options[packageSelect.selectedIndex];
      const planType = selectedOption.getAttribute('data-slug'); // basic, premium, enterprise

      const durationDays = parseInt(document.getElementById('durationDays').value);
      const neverExpires = document.getElementById('neverExpires').checked;

      if (!servicePackageId) {
        alert('âŒ Por favor selecciona un paquete de servicio');
        return;
      }

      // Obtener los lÃ­mites del paquete seleccionado
      const selectedPackage = allPackages.find(pkg => pkg.id === servicePackageId);

      const licenseData = {
        planType, // basic, premium, enterprise (para compatibilidad)
        servicePackageId, // ID del paquete
        clientLimit: selectedPackage?.clientLimit,
        userLimit: selectedPackage?.userLimit,
        branchLimit: selectedPackage?.branchLimit,
        featuresEnabled: selectedPackage?.featuresEnabled || {},
        price: selectedPackage?.price || 0,
        expiresInDays: neverExpires ? null : durationDays
      };

      try {
        const response = await fetch(`${API_URL}/licenses/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(licenseData)
        });

        const data = await response.json();

        if (data.success) {
          alert(`âœ… Licencia generada correctamente:\n\n${data.data.licenseKey}\n\nCopia esta clave y guÃ¡rdala en un lugar seguro.`);
          hideCreateLicenseDialog();
          loadLicenses();
        } else {
          alert(`âŒ Error: ${data.message}`);
        }
      } catch (error) {
        console.error('Error creating license:', error);
        alert('âŒ Error al generar la licencia');
      }
    }

    async function revokeLicense(licenseKey) {
      if (!confirm(`Â¿EstÃ¡s seguro de revocar la licencia ${licenseKey.substring(0, 16)}...?`)) return;

      try {
        const response = await fetch(`${API_URL}/licenses/${licenseKey}/revoke`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.success) {
          alert(`âœ… Licencia revocada correctamente`);
          loadLicenses();
        } else {
          alert(`âŒ Error: ${data.message}`);
        }
      } catch (error) {
        console.error('Error revoking license:', error);
        alert('âŒ Error al revocar la licencia');
      }
    }

    async function suspendLicense(licenseKey) {
      const reason = prompt('RazÃ³n de la suspensiÃ³n:', 'SuspensiÃ³n manual por administrador');
      if (!reason) return;

      const notes = prompt('Notas adicionales (opcional):', '');

      try {
        const response = await fetch(`${API_URL}/licenses/${licenseKey}/suspend`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason, notes })
        });

        const data = await response.json();

        if (data.success) {
          alert(`âœ… Licencia suspendida correctamente\n\nRazÃ³n: ${reason}`);
          loadLicenses();
        } else {
          alert(`âŒ Error: ${data.message}`);
        }
      } catch (error) {
        console.error('Error suspending license:', error);
        alert('âŒ Error al suspender la licencia');
      }
    }

    async function reactivateLicense(licenseKey) {
      if (!confirm(`Â¿Reactivar la licencia ${licenseKey.substring(0, 16)}...?`)) return;

      const notes = prompt('Notas de reactivaciÃ³n (opcional):', '');

      try {
        const response = await fetch(`${API_URL}/licenses/${licenseKey}/reactivate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ notes })
        });

        const data = await response.json();

        if (data.success) {
          alert(`âœ… Licencia reactivada correctamente\n\nNuevo estado: ${data.license.status}`);
          loadLicenses();
        } else {
          alert(`âŒ Error: ${data.message}`);
        }
      } catch (error) {
        console.error('Error reactivating license:', error);
        alert('âŒ Error al reactivar la licencia');
      }
    }

    async function triggerHeartbeat(licenseKey) {
      if (!confirm(`Â¿Forzar heartbeat inmediato para ${licenseKey.substring(0, 16)}...?`)) return;

      try {
        const response = await fetch(`${API_URL}/licenses/${licenseKey}/trigger-heartbeat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.success) {
          const msg = data.note || 'Comando enviado correctamente';
          alert(`âœ… ${msg}\n\nComando ID: ${data.command.id}\nEstado: ${data.command.status}`);
        } else {
          alert(`âŒ Error: ${data.message}`);
        }
      } catch (error) {
        console.error('Error triggering heartbeat:', error);
        alert('âŒ Error al forzar heartbeat');
      }
    }

    function getPlanText(planType) {
      const plans = {
        freemium: 'Freemium',
        basic: 'Basic',
        premium: 'Premium',
        enterprise: 'Enterprise',
        master: 'MASTER'
      };
      return plans[planType] || planType;
    }

    function getStatusBadgeClass(status) {
      const classes = {
        active: 'success',
        expired: 'danger',
        revoked: 'danger',
        pending: 'warning'
      };
      return classes[status] || 'info';
    }

    function getStatusText(status) {
      const texts = {
        active: 'Activa',
        expired: 'Expirada',
        revoked: 'Revocada',
        pending: 'Pendiente'
      };
      return texts[status] || status;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    // Toggle never expires checkbox
    document.getElementById('neverExpires').addEventListener('change', (e) => {
      document.getElementById('durationDays').disabled = e.target.checked;
    });

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filtered = allLicenses.filter(lic =>
        lic.licenseKey.toLowerCase().includes(searchTerm) ||
        (lic.installation && lic.installation.companyName.toLowerCase().includes(searchTerm))
      );
      renderLicenses(filtered);
    });

    // Load licenses on page load
    loadLicenses();

    // Auto-refresh every 60 seconds
    setInterval(loadLicenses, 60000);
  </script>
</body>
</html>
