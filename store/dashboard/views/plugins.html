<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plugins - ISP-Prueba Store</title>
  <link rel="stylesheet" href="/dashboard/static/css/dashboard.css">
</head>
<body>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>ISP-Prueba Store</h1>
        <p>Panel de AdministraciÃ³n</p>
      </div>
      <ul class="sidebar-menu">
        <li><a href="/dashboard">
          <span class="icon">ğŸ“Š</span> Dashboard
        </a></li>
        <li><a href="/dashboard/installations">
          <span class="icon">ğŸ’»</span> Instalaciones
        </a></li>
        <li><a href="/dashboard/licenses">
          <span class="icon">ğŸ”‘</span> Licencias
        </a></li>
        <li><a href="/dashboard/plugins" class="active">
          <span class="icon">ğŸ§©</span> Plugins
        </a></li>
        <li><a href="/dashboard/packages">
          <span class="icon">ğŸ“¦</span> Paquetes
        </a></li>
        <li><a href="/dashboard/customers">
          <span class="icon">ğŸ‘¥</span> Clientes
        </a></li>
        <li><a href="/dashboard/map">
          <span class="icon">ğŸ—ºï¸</span> Mapa
        </a></li>
      </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <h2>Plugins del Marketplace</h2>
        <p>Gestiona los plugins disponibles en la tienda</p>
      </div>

      <!-- Stats -->
      <div class="stats-grid" style="margin-bottom: 30px;">
        <div class="stat-card">
          <div class="stat-card-header">
            <span class="stat-card-title">Total Plugins</span>
            <div class="stat-card-icon" style="background: #e3f2fd; color: #2196f3;">ğŸ§©</div>
          </div>
          <div class="stat-card-value" id="totalPlugins">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-header">
            <span class="stat-card-title">Plugins Gratuitos</span>
            <div class="stat-card-icon" style="background: #e8f5e9; color: #4caf50;">ğŸ†“</div>
          </div>
          <div class="stat-card-value" id="freePlugins">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-header">
            <span class="stat-card-title">Total Descargas</span>
            <div class="stat-card-icon" style="background: #f3e5f5; color: #9c27b0;">â¬‡ï¸</div>
          </div>
          <div class="stat-card-value" id="totalDownloads">-</div>
        </div>
      </div>

      <!-- Data Table -->
      <div class="data-table">
        <div class="table-header">
          <h3>Todos los Plugins</h3>
          <div class="search-box">
            <span>ğŸ”</span>
            <input type="text" id="searchInput" placeholder="Buscar plugins...">
          </div>
        </div>
        <div id="pluginsTable">
          <div class="loading">
            <div class="spinner"></div>
            <p>Cargando plugins...</p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const API_URL = window.location.origin + '/api';
    let allPlugins = [];

    async function loadPlugins() {
      try {
        const response = await fetch(`${API_URL}/marketplace/plugins`);
        const data = await response.json();

        if (data.success) {
          allPlugins = data.data;
          renderPlugins(allPlugins);
          updateStats(allPlugins);
        }
      } catch (error) {
        console.error('Error loading plugins:', error);
        document.getElementById('pluginsTable').innerHTML = `
          <div class="loading">
            <p style="color: #e74c3c;">âŒ Error al cargar los plugins</p>
          </div>
        `;
      }
    }

    function updateStats(plugins) {
      document.getElementById('totalPlugins').textContent = plugins.length;
      document.getElementById('freePlugins').textContent = plugins.filter(p => p.isFree).length;
      document.getElementById('totalDownloads').textContent = plugins.reduce((sum, p) => sum + (p.downloadCount || 0), 0);
    }

    function renderPlugins(plugins) {
      const tableDiv = document.getElementById('pluginsTable');

      if (!plugins || plugins.length === 0) {
        tableDiv.innerHTML = '<p style="padding: 20px; text-align: center; color: #999;">No hay plugins disponibles</p>';
        return;
      }

      tableDiv.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Plugin</th>
              <th>VersiÃ³n</th>
              <th>CategorÃ­a</th>
              <th>Precio</th>
              <th>Descargas</th>
              <th>Rating</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            ${plugins.map(plugin => `
              <tr>
                <td>
                  <strong>${plugin.name}</strong><br>
                  <small style="color: #999;">${plugin.slug}</small>
                </td>
                <td><code>v${plugin.version}</code></td>
                <td><span class="badge badge-info">${getCategoryIcon(plugin.category)} ${getCategoryText(plugin.category)}</span></td>
                <td>
                  ${plugin.isFree ?
                    '<span class="badge badge-success">ğŸ†“ Gratis</span>' :
                    `<strong>$${plugin.price}</strong>`
                  }
                </td>
                <td><strong>${plugin.downloadCount || 0}</strong></td>
                <td>
                  ${plugin.rating ?
                    `â­ ${plugin.rating.toFixed(1)} (${plugin.reviewCount || 0})` :
                    '<span style="color: #999;">Sin reviews</span>'
                  }
                </td>
                <td>
                  ${plugin.isPublished ?
                    '<span class="badge badge-success">âœ… Publicado</span>' :
                    '<span class="badge badge-warning">â¸ï¸ Borrador</span>'
                  }
                </td>
                <td>
                  <button class="btn btn-primary btn-sm" onclick="viewPluginDetails('${plugin.id}')">ğŸ‘ï¸ Ver</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function getCategoryIcon(category) {
      const icons = {
        payment: 'ğŸ’³',
        communication: 'ğŸ’¬',
        analytics: 'ğŸ“Š',
        security: 'ğŸ”’',
        utility: 'ğŸ› ï¸',
        integration: 'ğŸ”—'
      };
      return icons[category] || 'ğŸ§©';
    }

    function getCategoryText(category) {
      const texts = {
        payment: 'Pagos',
        communication: 'ComunicaciÃ³n',
        analytics: 'Analytics',
        security: 'Seguridad',
        utility: 'Utilidad',
        integration: 'IntegraciÃ³n'
      };
      return texts[category] || category;
    }

    function viewPluginDetails(pluginId) {
      const plugin = allPlugins.find(p => p.id === pluginId);
      if (!plugin) return;

      // Sequelize retorna estos campos ya parseados como arrays/objetos
      // Solo parsear si vienen como strings
      const features = Array.isArray(plugin.features)
        ? plugin.features
        : (plugin.features ? JSON.parse(plugin.features) : []);

      const requirements = typeof plugin.requirements === 'object' && plugin.requirements !== null
        ? plugin.requirements
        : (plugin.requirements ? JSON.parse(plugin.requirements) : {});

      alert(`
ğŸ“¦ ${plugin.name}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ DescripciÃ³n:
${plugin.description}

â­ Features:
${features.map(f => `  â€¢ ${f}`).join('\n')}

ğŸ“‹ Requisitos:
  â€¢ VersiÃ³n mÃ­nima: ${requirements.minVersion || 'N/A'}
  â€¢ Licencia requerida: ${requirements.requiredLicense || 'N/A'}

ğŸ“Š EstadÃ­sticas:
  â€¢ Descargas: ${plugin.downloadCount || 0}
  â€¢ Rating: ${plugin.rating ? plugin.rating.toFixed(1) + ' â­' : 'Sin reviews'}
  â€¢ Autor: ${plugin.author || 'Desconocido'}

ğŸ’¾ Archivo:
  â€¢ Path: ${plugin.filePath || 'N/A'}
  â€¢ Hash: ${plugin.fileHash ? plugin.fileHash.substring(0, 16) + '...' : 'N/A'}
      `.trim());
    }

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filtered = allPlugins.filter(plugin =>
        plugin.name.toLowerCase().includes(searchTerm) ||
        plugin.slug.toLowerCase().includes(searchTerm) ||
        plugin.description.toLowerCase().includes(searchTerm)
      );
      renderPlugins(filtered);
    });

    // Load plugins on page load
    loadPlugins();

    // Auto-refresh every 60 seconds
    setInterval(loadPlugins, 60000);
  </script>
</body>
</html>
